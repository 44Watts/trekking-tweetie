<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trekking Tweetie</title>
<style>
  html,body{margin:0;height:100%;background:#9ad1f7;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{display:grid;place-items:center;min-height:100vh;padding:12px}
  #gameCanvas{background:linear-gradient(#aee1ff,#cbefff 60%,#a2e3a2);border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.2);image-rendering:pixelated;image-rendering:crisp-edges;touch-action:manipulation}
  .hud{position:fixed;inset:0;pointer-events:none;display:grid;place-items:start center;padding-top:10px;color:#06322b;font-weight:800;font-size:20px;text-shadow:0 2px 0 #fff8}
  .overlay{position:fixed;inset:0;display:none;place-items:center;z-index:10;background:transparent}
  .panel{pointer-events:auto;background:#ffffffc0;padding:18px 22px;border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.18);text-align:center}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;background:#ffd65c;color:#2b1b00;font-weight:700;cursor:pointer;box-shadow:0 4px 0 #bda044}
</style>
</head>
<body>
  <div class="wrap">
    <canvas id="gameCanvas" width="432" height="768"></canvas>
  </div>

  <div class="hud">
    <div><span id="scoreLabel">Score: 0</span> &nbsp;|&nbsp; <span id="bestLabel">Best: 0</span></div>
  </div>

  <div class="overlay" id="overlay">
    <div class="panel">
      <h2 id="title">Tap / Space to flap</h2>
      <div id="subtitle">Avoid the trees!</div><br>
      <button class="btn" id="startBtn" type="button">Start</button>
    </div>
  </div>

<script>
(() => {
  // ---------- CONFIG ----------
  const BOTTOM_VARIANTS = 6;        // how many bottom_*.png you have
  const OBSTACLE_SPAWN_SEC = 1.35;
  const SCROLL_SPEED_BASE = 200;
  const GAP_PIXELS_BASE = 180;
  const BIRD_SIZE_BASE = 44;
  const OBSTACLE_WIDTH = 110;
  const COLLISION_PAD = 6;

  const BIRD_SRC = "bird.png";
  const TOP_SRC  = "top.png";
  const BOTTOM_SRCS = Array.from({length: BOTTOM_VARIANTS}, (_,i)=>`bottom_${i+1}.png`);

  // ---------- ELEMENTS ----------
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d'); ctx.imageSmoothingEnabled = false;
  const scoreEl = document.getElementById('scoreLabel');
  const bestEl  = document.getElementById('bestLabel');
  const overlay = document.getElementById('overlay');
  const titleEl = document.getElementById('title');
  const subEl   = document.getElementById('subtitle');
  const startBtn= document.getElementById('startBtn');

  let birdImg, topImg, bottomImgs = [];
  let bird; // instantiate after images load
  let started = false, dead = false, running = false;
  let score = 0, best = Number(localStorage.getItem('treeflap_best')||0);
  bestEl.textContent = `Best: ${best}`;

  // ---------- RESIZE ----------
  function fitCanvas(){
    const maxH = Math.min(window.innerHeight*0.9, 900);
    const h = Math.round(maxH), w = Math.round(h*9/16);
    canvas.width = w; canvas.height = h;
  }
  fitCanvas(); window.addEventListener('resize', fitCanvas);

  const SCALE=()=>canvas.height/768, GRAVITY=()=>2800*SCALE(), FLAP_VY=()=>-600*SCALE();
  const SCROLL_SPEED=()=>SCROLL_SPEED_BASE*SCALE(), GAP_PIXELS=()=>GAP_PIXELS_BASE*SCALE();
  const BIRD_H=()=>Math.round(BIRD_SIZE_BASE*SCALE());

  function loadImage(src){
    return new Promise((res,rej)=>{
      const img=new Image();
      img.onload=()=>res(img);
      img.onerror=()=>rej(new Error("Failed to load "+src));
      img.src=src;
    });
  }

  async function preload(){
    console.log("Preloading imagesâ€¦");
    [birdImg, topImg] = await Promise.all([loadImage(BIRD_SRC), loadImage(TOP_SRC)]);
    bottomImgs = await Promise.all(BOTTOM_SRCS.map(loadImage));
    console.log("Images loaded:", {bird:birdImg.src, top:topImg.src, bottoms:bottomImgs.map(i=>i.src)});
  }

  // ---------- CLASSES ----------
  class Bird{
    constructor(){ this.reset(); }
    reset(){
      this.w = Math.round(BIRD_H()*(birdImg.naturalWidth/birdImg.naturalHeight));
      this.h = BIRD_H();
      this.x = Math.round(canvas.width*0.28);
      this.y = Math.round(canvas.height*0.45);
      this.vy = 0; this.rot = 0;
    }
    flap(){ this.vy = FLAP_VY(); }
    update(dt){
      this.vy += GRAVITY()*dt; this.y += this.vy*dt;
      const target = Math.max(-0.35, Math.min(0.6, this.vy/(900*SCALE())));
      this.rot += (target - this.rot)*0.15;
    }
    draw(){
      const cx=this.x+this.w/2, cy=this.y+this.h/2;
      ctx.save(); ctx.translate(cx,cy); ctx.rotate(this.rot);
      ctx.drawImage(birdImg, -this.w/2, -this.h/2, this.w, this.h);
      ctx.restore();
    }
    bbox(){ return {x:this.x+COLLISION_PAD,y:this.y+COLLISION_PAD,w:this.w-2*COLLISION_PAD,h:this.h-2*COLLISION_PAD}; }
  }

  class Obstacle {
    constructor(x) {
      this.bottomImg = bottomImgs[(Math.random() * bottomImgs.length) | 0];
      this.topImg = topImg;

      const botScale = OBSTACLE_WIDTH / this.bottomImg.naturalWidth;
      const topScale = OBSTACLE_WIDTH / this.topImg.naturalWidth;
      this.botW = OBSTACLE_WIDTH;
      this.botH = Math.round(this.bottomImg.naturalHeight * botScale);
      this.topW = OBSTACLE_WIDTH;
      this.topH = Math.round(this.topImg.naturalHeight * topScale);

      this.gap = GAP_PIXELS();
      this.x = x;
      this.passed = false;

      // Anchor bottom to ground
      this.botY = canvas.height - this.botH;
      // Place top one gap above
      this.topY = this.botY - this.gap - this.topH;
    }

    update(dt) { this.x -= SCROLL_SPEED() * dt; }

    draw(ctx) {
      ctx.drawImage(this.topImg, this.x, this.topY, this.topW, this.topH);
      ctx.drawImage(this.bottomImg, this.x, this.botY, this.botW, this.botH);
    }

    offscreen() { return this.x + this.topW < 0; }

    passedBy(bird) {
      if (!this.passed && this.x + this.topW < bird.x) { this.passed = true; return true; }
      return false;
    }

    collides(bird) {
      const b = bird.bbox();
      const topBox = { x: this.x + COLLISION_PAD, y: this.topY + COLLISION_PAD, w: this.topW - 2 * COLLISION_PAD, h: this.topH - 2 * COLLISION_PAD };
      const botBox = { x: this.x + COLLISION_PAD, y: this.botY + COLLISION_PAD, w: this.botW - 2 * COLLISION_PAD, h: this.botH - 2 * COLLISION_PAD };
      return aabb(b, topBox) || aabb(b, botBox);
    }
  }

  function aabb(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;}

  // Game state
  let obstacles=[]; let spawnTimer=0; let lastTime=0;

  function resetGame(){
    console.log("Reset game");
    score=0; scoreEl.textContent="Score: 0";
    dead=false; started=false; running=false;
    bird.reset(); obstacles=[]; spawnTimer=0;
    showOverlay("Tap / Space to flap","Avoid the trees!",true);
    drawStaticFrame();
  }

  function startGame(){
    if (running) return;
    console.log("Start game");
    started=true; dead=false; running=true; hideOverlay();
    lastTime=performance.now();
    requestAnimationFrame(loop);
  }

  function gameOver(){
    console.log("Game over");
    dead=true; started=false; running=false;
    if(score>best){best=score;localStorage.setItem('treeflap_best',best);}
    bestEl.textContent=`Best: ${best}`;
    showOverlay("Game Over",`Score: ${score}`,true);
  }

  function spawnObstacle(){ obstacles.push(new Obstacle(canvas.width+20)); }

  function loop(ts){
    if(!running) return;
    const dt=Math.min(0.033,(ts-lastTime)/1000); lastTime=ts;

    bird.update(dt);
    spawnTimer+=dt; if(spawnTimer>=OBSTACLE_SPAWN_SEC){spawnTimer=0;spawnObstacle();}
    obstacles.forEach(o=>o.update(dt));
    obstacles=obstacles.filter(o=>!o.offscreen());

    for(const o of obstacles){
      if(o.collides(bird)){ gameOver(); break; }
      if(o.passedBy(bird)){ score++; scoreEl.textContent=`Score: ${score}`; }
    }
    if(!dead&&(bird.y+bird.h>=canvas.height||bird.y<=0)) gameOver();

    draw();
    if(!dead) requestAnimationFrame(loop);
  }

  function drawBackground(){
    const g=ctx.createLinearGradient(0,0,0,canvas.height);
    g.addColorStop(0,"#aee1ff");
    g.addColorStop(0.6,"#cbefff");
    g.addColorStop(1,"#a2e3a2");
    ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="#3e7c3e"; ctx.fillRect(0,canvas.height-12*SCALE(),canvas.width,12*SCALE());
  }
  function draw(){ drawBackground(); obstacles.forEach(o=>o.draw(ctx)); bird.draw(ctx); }
  function drawStaticFrame(){
    drawBackground();
    if (bottomImgs.length && topImg) {
      const preview = new Obstacle(Math.round(canvas.width*0.65));
      preview.draw(ctx);
    }
    if (bird) bird.draw(ctx);
  }

  function showOverlay(title,subtitle,showBtn){
    titleEl.textContent=title; subEl.textContent=subtitle||"";
    startBtn.style.display = showBtn? "inline-block":"none";
    overlay.style.display="grid";
  }
  function hideOverlay(){ overlay.style.display="none"; }

  // ------- INPUT -------
  const flap=()=>{
    if(dead) return;
    if(!running) startGame();
    bird.flap();
  };
  window.addEventListener('keydown',e=>{
    if(['Space','ArrowUp','KeyW'].includes(e.code)){ e.preventDefault(); flap(); }
    else if(e.code==='Enter' && dead){ resetGame(); }
  });
  window.addEventListener('pointerdown', e=>{
    if (e.target !== startBtn) flap();
  });
  startBtn.addEventListener('click', ()=>{ if(dead) resetGame(); else startGame(); });

  // ------- INIT -------
  preload().then(()=>{
    bird = new Bird();
    resetGame();
  }).catch(err=>{
    console.error(err);
    showOverlay("Couldn't load images","Check file names & paths",false);
  });
})();
</script>
</body>
</html>

